<!-- ============================
     FILE: main.html (Polished + Qty & Cancel)
     ============================ -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Eventify | Explore Events</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0d0d1b;--panel:#1e1e2f;--panel-2:#1a1a2e;--fg:#fff;--muted:#cbd5e1;--muted-2:#aaa;--chip:#111827;--chip-b:#334155;--accent:#6c63ff;--accent-2:#574bff;--brand:#a855f7;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  body{background-color:var(--bg);color:var(--fg);min-height:100vh}
  nav{display:flex;justify-content:space-between;align-items:center;background:var(--panel-2);padding:15px 20px;box-shadow:0 2px 10px rgba(0,0,0,.5);position:sticky;top:0;z-index:10}
  nav h1{color:var(--brand);font-size:22px;font-weight:700}
  nav .right{display:flex;gap:10px;align-items:center}
  nav .chip{font-size:12px;color:#cbd5e1;background:var(--chip);border:1px solid var(--chip-b);padding:6px 10px;border-radius:999px}
  nav button{background:var(--accent);border:none;padding:8px 14px;color:var(--fg);border-radius:8px;cursor:pointer;transition:.2s}
  nav button:hover{background:var(--accent-2)}
  .container{padding:24px}
  .filters{display:flex;gap:10px;margin:14px 0 24px;flex-wrap:wrap}
  select,input[type="date"],input[type="text"]{background:var(--panel);color:var(--fg);border:none;padding:10px 14px;border-radius:8px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:22px}
  .card{background:var(--panel);border-radius:14px;overflow:hidden;transition:.25s;box-shadow:0 0 15px rgba(0,0,0,.4)}
  .card:hover{transform:translateY(-4px) scale(1.01);box-shadow:0 0 24px rgba(168,85,247,.3)}
  .card img{width:100%;height:180px;object-fit:cover;display:block}
  .card-content{padding:14px}
  .card-content h3{font-size:18px;margin-bottom:6px;color:var(--fg)}
  .card-content p{color:var(--muted-2);font-size:14px;margin-bottom:4px}
  .price{color:var(--brand);font-weight:700;margin:6px 0}
  .card button{background:var(--brand);border:none;color:var(--fg);padding:8px 12px;border-radius:6px;margin-top:8px;cursor:pointer}
  .card button:hover{background:#7c3aed}
  .detail{display:none;padding:28px;text-align:center;animation:fadeIn .35s ease;max-width:1000px;margin:auto}
  .detail img{width:100%;max-width:700px;border-radius:12px;margin-bottom:16px;box-shadow:0 0 20px rgba(168,85,247,.3)}
  .detail h2{margin-bottom:8px;color:var(--fg)}
  .detail p{max-width:700px;margin:8px auto;color:#bbb}
  .detail .price{font-size:18px;margin:10px;color:var(--brand)}
  .detail button{background:var(--accent);border:none;padding:10px 20px;border-radius:8px;color:var(--fg);margin:10px;cursor:pointer}
  .detail button:hover{background:var(--accent-2)}
  .qty-wrap{display:flex;align-items:center;justify-content:center;gap:8px;margin:8px 0 4px}
  .qty-wrap input{width:80px;text-align:center}
  .hint{font-size:12px;color:#cbd5e1;opacity:.9}
  .empty{opacity:.8;text-align:center;padding:24px;border:1px dashed var(--chip-b);border-radius:12px}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @media (prefers-reduced-motion: reduce){*{transition:none!important;animation:none!important}}
</style>
</head>
<body>
<nav aria-label="Top bar">
  <h1>Eventify</h1>
  <div class="right">
    <span id="userChip" class="chip" title="Signed in as"></span>
    <button id="viewBookingsBtn" type="button">View My Bookings</button>
    <button id="logoutBtn" type="button">Logout</button>
  </div>
</nav>

<main class="container" id="mainContainer">
  <h2 style="margin-bottom:12px;">Upcoming Events</h2>
  <div class="filters" aria-label="Filters">
    <label class="sr-only" for="searchBox">Search events</label>
    <input id="searchBox" type="text" placeholder="Search by title or venue" />

    <label class="sr-only" for="cityFilter">Filter by city</label>
    <select id="cityFilter">
      <option value="All">All Cities</option>
      <option>Bengaluru</option>
      <option>Pune</option>
      <option>Kolkata</option>
      <option>Mumbai</option>
      <option>Chennai</option>
      <option>Delhi</option>
      <option>Goa</option>
      <option>Hyderabad</option>
      <option>Jaipur</option>
      <option>Ahmedabad</option>
    </select>

    <label class="sr-only" for="dateFilter">Filter by exact date</label>
    <input type="date" id="dateFilter" />
  </div>
  <div id="eventGrid" class="grid" aria-live="polite"></div>
</main>

<section id="eventDetail" class="detail" aria-live="polite"></section>

<script>
// ------------------ CONFIG --------------------
const BASE_URL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
  ? 'http://127.0.0.1:5000'
  : 'https://eventify-backend-yjmb.onrender.com';

// ------------------ SAMPLE EVENTS (more added) --------------------
const events = [
  {id:1,title:"Indie Rock Night",city:"Bengaluru",date:"2025-10-31",price:499,venue:"Blue Orchid Club",image:"https://images.unsplash.com/photo-1507874457470-272b3c8d8ee2?auto=format&fit=crop&w=1200&q=60",description:"An electrifying night of indie rock bands, bright lights, and pure energy."},
  {id:2,title:"Startup Workshop",city:"Pune",date:"2025-11-15",price:299,venue:"CoWork Studio",image:"https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1200&q=60",description:"Hands-on workshop on MVP and pitching."},
  {id:3,title:"Classical Evening",city:"Kolkata",date:"2025-11-20",price:799,venue:"Heritage Hall",image:"https://images.unsplash.com/photo-1497032628192-86f99bcd76bc?auto=format&fit=crop&w=1200&q=60",description:"An evening of classical maestros."},
  {id:4,title:"Food Carnival",city:"Mumbai",date:"2025-11-22",price:199,venue:"Seaside Market",image:"https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?auto=format&fit=crop&w=1200&q=60",description:"Taste the best street food and desserts."},
  {id:5,title:"Local Football Match",city:"Chennai",date:"2025-12-05",price:149,venue:"City Stadium",image:"https://images.unsplash.com/photo-1517649763962-0c623066013b?auto=format&fit=crop&w=1200&q=60",description:"Support local teams and enjoy the match."},
  {id:6,title:"Tech Conference 2025",city:"Delhi",date:"2025-12-10",price:999,venue:"TechPark Arena",image:"https://images.unsplash.com/photo-1522199755839-a2bacb67c546?auto=format&fit=crop&w=1200&q=60",description:"Indiaâ€™s biggest technology conference."},
  {id:7,title:"Art & Craft Exhibition",city:"Pune",date:"2025-11-30",price:249,venue:"City Gallery",image:"https://images.unsplash.com/photo-1542038784456-1ea8e935640e?auto=format&fit=crop&w=1200&q=60",description:"Explore artisans and handcrafted art."},
  {id:8,title:"Beach Music Fest",city:"Goa",date:"2025-12-20",price:599,venue:"Miramar Beach",image:"https://images.unsplash.com/photo-1521334884684-d80222895322?auto=format&fit=crop&w=1200&q=60",description:"Party by the waves with live DJs!"},
  // New additions
  {id:9,title:"Hyderabad Comic Con",city:"Hyderabad",date:"2025-12-13",price:699,venue:"Hitex",image:"https://images.unsplash.com/photo-1511512578047-dfb367046420?auto=format&fit=crop&w=1200&q=60",description:"Cosplay, merch, panels, and tons of fandom fun."},
  {id:10,title:"Jaipur Literature Fest Preview",city:"Jaipur",date:"2026-01-05",price:399,venue:"Pink City Hall",image:"https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1200&q=60",description:"Author talks, poetry slams, and book signings."},
  {id:11,title:"Stand-up Night",city:"Bengaluru",date:"2025-12-08",price:349,venue:"Indiranagar Club",image:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=60",description:"Fresh sets from rising comedians."},
  {id:12,title:"Carnatic Concert",city:"Chennai",date:"2025-12-28",price:599,venue:"Music Academy",image:"https://images.unsplash.com/photo-1484591974057-265bb767ef71?auto=format&fit=crop&w=1200&q=60",description:"Soulful ragas by renowned artists."},
  {id:13,title:"Street Photography Walk",city:"Mumbai",date:"2025-12-14",price:249,venue:"Fort Area",image:"https://images.unsplash.com/photo-1483721310020-03333e577078?auto=format&fit=crop&w=1200&q=60",description:"Learn composition and storytelling on the streets."},
  {id:14,title:"Data Science Meetup",city:"Ahmedabad",date:"2025-12-11",price:199,venue:"TechHub",image:"https://images.unsplash.com/photo-1518779578993-ec3579fee39f?auto=format&fit=crop&w=1200&q=60",description:"Talks on ML ops, LLMs, and deployments."},
  {id:15,title:"New Year Bash",city:"Goa",date:"2025-12-31",price:1299,venue:"Baga Beach",image:"https://images.unsplash.com/photo-1514525253161-7a46d19cd819?auto=format&fit=crop&w=1200&q=60",description:"Ring in 2026 with fireworks and DJs."}
];

// ------------------ DOM --------------------
const grid = document.getElementById('eventGrid');
const detail = document.getElementById('eventDetail');
const main = document.getElementById('mainContainer');
const cityFilter = document.getElementById('cityFilter');
const dateFilter = document.getElementById('dateFilter');
const searchBox = document.getElementById('searchBox');
const userChip = document.getElementById('userChip');
const viewBookingsBtn = document.getElementById('viewBookingsBtn');
const logoutBtn = document.getElementById('logoutBtn');

// ------------------ UTIL --------------------
const inr = new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'});
function fmtDate(str){ const d = new Date(str + 'T00:00:00'); return d.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' }); }
function todayISO(){ const t = new Date(); const off = t.getTimezoneOffset(); const d = new Date(t.getTime() - off*60000); return d.toISOString().slice(0,10); }
function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }
function fallbackImg(ev){ ev.target.src = 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="600"><rect width="100%" height="100%" fill="#1e1e2f"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#cbd5e1" font-family="Poppins,Arial" font-size="24">Image unavailable</text></svg>`); }
function setHash(id){ location.hash = `#event-${id}`; }
function getHashId(){ const m = location.hash.match(/#event-(\d+)/); return m ? Number(m[1]) : null; }

// ------------------ SESSION GUARD --------------------
(function guard(){
  const email = localStorage.getItem('userEmail');
  if(!email){
    alert('Please log in first.');
    location.href = '/index.html';
  } else { userChip.textContent = email; }
})();

// ------------------ RENDER CARDS --------------------
function createCard(e){
  const card = document.createElement('article');
  card.className = 'card'; card.setAttribute('tabindex','0');

  const img = document.createElement('img');
  img.src = e.image; img.loading = 'lazy'; img.alt = e.title + ' banner';
  img.addEventListener('error', fallbackImg);
  card.appendChild(img);

  const cont = document.createElement('div'); cont.className = 'card-content';
  const h3 = document.createElement('h3'); h3.textContent = e.title; cont.appendChild(h3);
  const meta = document.createElement('p'); meta.textContent = `${e.venue} â€¢ ${e.city}`; cont.appendChild(meta);
  const date = document.createElement('p'); date.textContent = `Date: ${fmtDate(e.date)}`; cont.appendChild(date);
  const price = document.createElement('p'); price.className='price'; price.textContent = inr.format(e.price); cont.appendChild(price);

  const btn = document.createElement('button'); btn.type='button'; btn.textContent='View';
  btn.addEventListener('click', () => viewEvent(e.id));
  cont.appendChild(btn);

  card.appendChild(cont);
  card.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') viewEvent(e.id); });
  return card;
}

function showEvents(list){
  clear(grid);
  if(!list.length){
    const empty = document.createElement('div');
    empty.className = 'empty';
    empty.textContent = 'No events match your filters.';
    grid.appendChild(empty); return;
  }
  list.forEach(e => grid.appendChild(createCard(e)));
}

// ------------------ FILTERS --------------------
function getFiltered(){
  const q = searchBox.value.trim().toLowerCase();
  const city = cityFilter.value;
  const date = dateFilter.value;
  const t = todayISO();

  let list = events
    .filter(e => e.date >= t) // show only upcoming by default
    .sort((a,b) => a.date.localeCompare(b.date));

  if(city !== 'All') list = list.filter(e => e.city === city);
  if(date) list = list.filter(e => e.date === date);
  if(q) list = list.filter(e => e.title.toLowerCase().includes(q) || e.venue.toLowerCase().includes(q));
  return list;
}

function applyFilters(){ showEvents(getFiltered()); }
function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args),ms); } }
cityFilter.addEventListener('change', applyFilters);
dateFilter.addEventListener('change', applyFilters);
searchBox.addEventListener('input', debounce(applyFilters, 150));

// ------------------ DETAIL VIEW (with quantity) --------------------
function viewEvent(id){
  const e = events.find(ev => ev.id === id);
  if(!e) return;
  main.style.display = 'none';
  detail.style.display = 'block';
  clear(detail);

  const img = document.createElement('img'); img.src = e.image; img.alt = e.title + ' banner'; img.loading='lazy'; img.addEventListener('error', fallbackImg);
  const h2 = document.createElement('h2'); h2.textContent = e.title;
  const meta = document.createElement('p'); meta.textContent = `${e.venue} â€¢ ${e.city} â€¢ ${fmtDate(e.date)}`;
  const desc = document.createElement('p'); desc.textContent = e.description;
  const price = document.createElement('p'); price.className='price'; price.textContent = inr.format(e.price);

  // Quantity selector
  const qtyWrap = document.createElement('div'); qtyWrap.className = 'qty-wrap';
  const qtyLabel = document.createElement('label'); qtyLabel.className='sr-only'; qtyLabel.setAttribute('for','ticketQty'); qtyLabel.textContent='Number of tickets';
  const minus = document.createElement('button'); minus.type='button'; minus.textContent='âˆ’';
  const qty = document.createElement('input'); qty.id='ticketQty'; qty.type='number'; qty.min='1'; qty.max='10'; qty.value='1';
  const plus = document.createElement('button'); plus.type='button'; plus.textContent='+';
  minus.addEventListener('click', ()=>{ qty.value = Math.max(1, (parseInt(qty.value)||1)-1); });
  plus.addEventListener('click', ()=>{ qty.value = Math.min(10, (parseInt(qty.value)||1)+1); });
  qtyWrap.append(qtyLabel, minus, qty, plus);

  const hint = document.createElement('div'); hint.className='hint'; hint.textContent='Max 10 per booking (adjustable).';

  const book = document.createElement('button'); book.textContent='Book Now';
  book.addEventListener('click', () => bookEvent(e.title, Number(qty.value || 1)));
  const back = document.createElement('button'); back.textContent='Back'; back.addEventListener('click', goBack);

  detail.append(img,h2,meta,desc,price,qtyWrap,hint,book,back);
  setHash(id);
}

function goBack(){ detail.style.display = 'none'; main.style.display = 'block'; location.hash = ''; }

// Deep-link support via #event-<id>
window.addEventListener('hashchange', ()=>{ const id = getHashId(); if(id) viewEvent(id); else goBack(); });

// ------------------ AUTH ACTIONS --------------------
logoutBtn.addEventListener('click', () => {
  if(confirm('Log out of Eventify?')){
    localStorage.removeItem('userEmail');
    location.href = '/index.html';
  }
});

// ------------------ BOOKINGS API (quantity + cancel) --------------------
async function bookEvent(title, quantity){
  const userEmail = localStorage.getItem('userEmail');
  if(!userEmail){ alert('Session expired. Please log in again.'); return location.href = 'login.html'; }

  if(!Number.isFinite(quantity) || quantity < 1){ quantity = 1; }

  const controller = new AbortController();
  const timeout = setTimeout(()=>controller.abort(), 10000);

  try{
    const res = await fetch(`${BASE_URL}/api/book`,{
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      signal:controller.signal,
      body: JSON.stringify({ eventTitle:title, userEmail, quantity })
    });
    if(!res.ok) throw new Error('Bad response');
    const payload = await res.json();
    alert('ðŸŽŸï¸ Booking confirmed and saved!');
  }catch(err){
    console.error(err);
    alert('Booking failed â€” is the backend running?');
  }finally{ clearTimeout(timeout); }
}

viewBookingsBtn.addEventListener('click', viewBookings);

function fmtBookingTime(val){
  try { return val ? new Date(val).toLocaleString('en-IN') : ''; }
  catch { return ''; }
}

async function viewBookings(){
  const userEmail = localStorage.getItem('userEmail');
  if(!userEmail){ alert('Please log in.'); return; }

  const controller = new AbortController();
  const timeout = setTimeout(()=>controller.abort(), 10000);

  try{
    const res = await fetch(`${BASE_URL}/api/bookings?userEmail=${encodeURIComponent(userEmail)}`, { signal: controller.signal });
    if(!res.ok) throw new Error('Bad response');
    const data = await res.json();

    main.style.display = 'none';
    detail.style.display = 'block';
    clear(detail);

    const h2 = document.createElement('h2'); h2.textContent = 'ðŸ“… My Bookings';
    const wrap = document.createElement('div');
    wrap.style.textAlign = 'left'; wrap.style.maxWidth = '700px'; wrap.style.margin = '16px auto';

    if(!Array.isArray(data) || data.length === 0){
      const p = document.createElement('p'); p.textContent = 'No bookings found.'; wrap.appendChild(p);
    } else {
      data.forEach(b => {
        const item = document.createElement('div');
        item.style.background = '#1e1e2f'; item.style.padding='12px'; item.style.margin='10px 0'; item.style.borderRadius='8px'; item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center';

        const left = document.createElement('div');
        const title = document.createElement('strong'); title.textContent = b.eventTitle || 'Untitled event';
        const meta = document.createElement('div'); meta.style.fontSize='12px'; meta.style.color='#cbd5e1';
        const when = fmtBookingTime(b.date || b.createdAt);
        const qty = b.quantity != null ? ` â€¢ Qty: ${b.quantity}` : '';
        const emailLine = b.userEmail ? ` â€¢ ${b.userEmail}` : '';
        meta.textContent = [when, qty, emailLine].filter(Boolean).join('');

        left.append(title, meta);

        const right = document.createElement('div');
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.background = '#ef4444';
        cancelBtn.style.border = 'none';
        cancelBtn.style.padding = '8px 12px';
        cancelBtn.style.borderRadius = '6px';
        cancelBtn.style.cursor = 'pointer';
        cancelBtn.addEventListener('click', () => cancelBooking(b));

        right.appendChild(cancelBtn);

        item.append(left, right);
        wrap.appendChild(item);
      });
    }

    const back = document.createElement('button'); back.textContent='Back'; back.addEventListener('click', goBack);

    detail.append(h2, wrap, back);
  }catch(err){
    console.error(err);
    alert('Failed to fetch bookings.');
  }finally{ clearTimeout(timeout); }
}

/**
 * Try to cancel a booking robustly:
 * 1) If booking has id/_id -> DELETE /api/booking/:id
 * 2) Fallback -> POST /api/cancel with {bookingId,eventTitle,userEmail}
 */
async function cancelBooking(booking){
  const userEmail = localStorage.getItem('userEmail');
  if(!userEmail){ alert('Please log in.'); return; }
  if(!confirm('Cancel this booking?')) return;

  const id = booking._id || booking.id;
  const controller = new AbortController();
  const timeout = setTimeout(()=>controller.abort(), 10000);

  try{
    let ok = false;

    // Attempt DELETE by id if present
    if(id){
      const delRes = await fetch(`${BASE_URL}/api/booking/${encodeURIComponent(id)}`, {
        method:'DELETE',
        signal: controller.signal
      });
      ok = delRes.ok;
    }

    // Fallback to POST /api/cancel
    if(!ok){
      const res = await fetch(`${BASE_URL}/api/cancel`,{
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        signal: controller.signal,
        body: JSON.stringify({
          bookingId: id || null,
          eventTitle: booking.eventTitle,
          userEmail
        })
      });
      ok = res.ok;
    }

    if(!ok) throw new Error('Cancel failed');
    alert('âœ… Booking cancelled.');
    // Refresh bookings list
    viewBookings();
  }catch(err){
    console.error(err);
    alert('Cancellation failed.');
  }finally{
    clearTimeout(timeout);
  }
}

// ------------------ INIT --------------------
(function init(){
  showEvents(getFiltered());
  const deepId = getHashId(); if(deepId) viewEvent(deepId);
})();
</script>
</body>
</html>
